<!DOCTYPE html>
<html>
    <head>
        <title>Web App - BioScan</title>

        <link rel="stylesheet" type="text/css" href="static/resize/css/imgareaselect-default.css" />
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script type="text/javascript" src="static/resize/scripts/jquery.min.js"></script>
        <script type="text/javascript" src="static/resize/scripts/jquery.imgareaselect.pack.js"></script>
        <script src="static/js/jquery-ui.js"></script>

        <script src="static/js/sweetalert.min.js"></script>

        <style type="text/css">

            .mode-button {
              border: 4px solid black;
              border-radius: 10px;
              width: 150px;
              height: 100px;
              font-size: 100%;
              font-weight: bold;
              background: none;
            }

            .mode-button:hover {
              background: black;
              color: white;
            }

            .selected {
              background: black;
              color: white;
              border: 4px solid white;
            }

            .icon-button {
              background: white;
              border: 4px solid black;
              border-radius: 10px;
            }

            .icon-button:hover {
              box-shadow: 5px 10px;
            }

            .icon-image {
              width: 40px;
              height: 40px;
              padding: 10px;
            }

            .box {
              width: 80%;
              padding: 20px;
              border: 4px solid black;
              border-radius: 10px;
              vertical-align: center;
              font-size: 100%;
            }

            .option-button {
              border: 4px solid black;
              border-radius: 10px;
              width: 60px;
              font-size: 90%;
              font-weight: bold;
              background: none;
              margin-left: 2px;
              margin-right: 2px;
              word-wrap: break-word;
            }

            .option-button:hover {
              background: black;
              color: white;
            }

            .operation-button {
              border: 4px solid black;
              border-radius: 10px;
              width: 90px;
              padding: 10px;
              font-size: 90%;
              font-weight: bold;
              background: none;
              margin-left: 2px;
              margin-right: 2px;
              word-wrap: break-word;
            }

            .operation-button:hover {
              background: black;
              color: white;
            }

            #options-box {
              display: flex;
              align-items: center;
              justify-content: center;
            }

            #manual-search {
              width: 100px;
              word-wrap: break-word;
              background: white;
              border: 4px solid black;
              border-radius: 10px;
              font-weight: bold;
              font-size: 100%;
            }

        </style>
    </head>

    <body>
      {% if upload %}
        <form method="post" enctype="multipart/form-data">
          <input type="file" name="inputFile">
          <input type="submit" name="inputSubmit">
        </form>
      {% else %}
        <audio id="warning" src="static/alarm/warning.mp3"></audio>

        <div class="after-content" id="container">
          <img src="{{img}}" id="img" style="width: 60%; height; 100%; float: left;">
          <form method="post" style="float: left; margin-left: 10%;">
            <div>
              <p>
                <button type="button" id="pseudo-mode" class='mode-button'>Pseudo colored</button>
                <button type="button" id="grayscale-mode" class='mode-button'>Grayscale</button>
              </p>

              <p>
                <button type="button" id="om-mode" class='mode-button'>OM</button>
                <button type="button" id="vcplus-mode" class='mode-button'>VC+</button>
              </p>

              <p>
                <div class="box">
                  <strong>Scan number:</strong> {{updated_count}} <br><br>
                  <strong>Scan mode:</strong> {{mode}} <br><br>
                  <strong>System status:</strong> <br><br>
                  <strong>Image Status:</strong> <br><br>
                </div>
              </p>

              <h3>View Options</h3>
              <div class="box" style="margin-top: -15px;">
                <div>
                  <div id="options-box">
                    <button type="button" id="pseudo-option" class='option-button'>Color</button>
                    <button type="button" id="om-option" class='option-button'>OM</button>
                    <button type="button" id="im-option" class='option-button'>IM</button>
                    <button type="button" id="vcminus-option" class='option-button'>VC-</button>
                  </div>
                </div>
                <div>
                  <div id="options-box">
                    <button type="button" id="cc-option" class='option-button'>CC</button>
                    <button type="button" id="obj-option" class='option-button'>OBJ</button>
                    <button type="button" id="bw-option" class='option-button'>Gray</button>
                    <button type="button" id="inv-option" class='option-button'>Inv</button>
                  </div>
                </div>
              </div>

              <h3>Operation</h3>
              <div class="box" style="margin-top: -15px;">
                <div>
                  <div id="options-box">
                    <button type="button" id="#" class='operation-button'>Send</button>
                    <button type="button" id="#" class='operation-button'>Francais</button>
                  </div>
                </div>
                <div>
                  <div id="options-box">
                    <button type="button" id="zeff-operation" class='operation-button'>Zeff</button>
                    <button type="button" id="nn-operation" class='operation-button'>NN</button>
                  </div>
                </div>
                <div>
                  <div id="options-box">
                    <button type="button" id="jaccard-operation" class='operation-button'>Jaccard</button>
                    <button type="button" id="cosine-operation" class='operation-button'>Cosine</button>
                  </div>
                </div>
              </div>

              <p style="text-align: center;">
                <button type="button" id="grayscale-mode" class='icon-button'><img class='icon-image' src="static/ecil_icons/previous.png"></button>
                <button type="button" id="pseudo-mode" class='icon-button'><img class='icon-image' src="static/ecil_icons/stop.png"></button>
                <button type="button" id="grayscale-mode" class='icon-button'><img class='icon-image' src="static/ecil_icons/next.png"></button>
              </p>
            </div>
          </form>
        </div>
      {% endif %}

      <script type="text/javascript">
        $(document).ready(function() {
            /*
              FUNCTIONS
            */
            function mode_request(mode_name, show_please_wait=false, send_data=false) {
              var id_to_endpoint = {
                // Modes
                "pseudo-mode": "/rgb",
                "grayscale-mode": "/gray",
                "om-mode": "/om",
                "vcplus-mode": "/vcplus",

                // Options
                "pseudo-option": "/rgb",
                "om-option": "/om",
                "im-option": "/im",
                "vcminus-option": "/vcminus",
                "cc-option": "/cc",
                "obj-option": "/obj",
                "bw-option": "/gray",
                "inv-option": "/inv",
              }

              if(show_please_wait) {
                swal({
                  title: "Processing...",
                  text: "Please wait"
                });
              }

              var data = {}
              if(send_data)
                var data = {"saveMode": true}

              $.ajax({
                url: id_to_endpoint[mode_name],
                type: "post",
                dataType: "json",
                data: data,
                success: function(result) {
                  if(show_please_wait)
                    swal.close();
                  $("#img").attr("src", result.img);
                }
              });
            }

            function play_warning_audio() {
              var audio = document.getElementById("warning");
              audio.currentTime = 0;
              audio.play();
              audio.loop = true;
            }

            function stop_warning_audio() {
              var audio = document.getElementById("warning");
              audio.pause();
            }

            /*
              INITIAL SETUP
            */
            var mode_name = "{{mode}}";
            $("#" + mode_name).addClass("selected");

            if(mode_name != "pseudo-mode") {
              mode_request(mode_name);
            }

            /*
              LOGIC
            */
            $(".mode-button").click(function() {
              var mode_name = $(this).attr("id");

              if(!$(this).hasClass("selected")) {
                mode_request(mode_name, show_please_wait=true, send_data=true);
              } else {
                var id_to_name = {
                  "pseudo-mode": "Pseuo colored",
                  "grayscale-mode": "Grayscale",
                  "om-mode": "OM",
                  "vcplus-mode": "VC Plus"
                }

                window.swal({
                  icon: "info",
                  title: "You clicked",
                  text: "Mode: " + id_to_name[mode_name] + " already selected!",
                });
              }

              $(".selected").removeClass("selected");
              $(this).addClass("selected");
            });

            $(".option-button").click(function() {
              var option_name = $(this).attr("id");
              mode_request(option_name, show_please_wait=true);
            });

            var imagesize = $('#img').width();
            var x1 = 0, x2 = 0, y1 = 0, y2 = 0, height=0, width=0;

            $("#img").imgAreaSelect({
              handles: true,
              onSelectEnd: function(img, selection) {
                height = img.height;
                width = img.width;
                x1 = selection.x1;
                x2 = selection.x2;
                y1 = selection.y1;
                y2 = selection.y2;
              }
            });

            var $ias = $('#img').imgAreaSelect({
                instance: true
            });

            $("#zeff-operation").click(function() {
              var filename = $("#img").attr("src");

              if(x1 == 0 && x2 == 0 && y1 == 0 && y2 == 0) {
                window.swal({
                  title: "Error!",
                  text: "Select an area"
                });
              } else {
                window.swal({
                  title: "Processing...",
                  text: "Please wait"
                });

                var height_ratio = height / 512;
                var width_ratio = width / 640;
                var scaled_x1 = x1 / height_ratio;
                var scaled_y1 = y1 / width_ratio;

                $.ajax({
                  url: "/zeff",
                  type: "post",
                  dataType: "json",
                  data: {x1: scaled_x1, x2: x2, y1: scaled_y1, y2: y2, filename: filename},
                  success: function(result) {
                    $ias.cancelSelection();
                    swal.close();
                    window.swal({
                      title: "Result (zeff)",
                      text: "Zeff = " + result.zeff
                    });
                    x1 = 0;
                    x2 = 0;
                    y1 = 0;
                    y2 = 0;
                  }
                });
              }
            });

            $("#nn-operation").click(function() {
              var filename = $("#img").attr("src");

              if(x1 == 0 && x2 == 0 && y1 == 0 && y2 == 0) {
                window.swal({
                  title: "Error!",
                  text: "Select an area"
                });
              } else {
                window.swal({
                  title: "Predicting...",
                  text: "Please wait"
                });

                var height_ratio = height / 512;
                var width_ratio = width / 640;
                var scaled_x1 = x1 / height_ratio;
                var scaled_y1 = y1 / width_ratio;

                $.ajax({
                  url: "/predict",
                  type: "post",
                  dataType: "json",
                  data: {x1: scaled_x1, x2: x2, y1: scaled_y1, y2: y2, filename: filename},
                  success: function(result) {
                    if(result.icon == "error") {
                      play_warning_audio();
                    }

                    $ias.cancelSelection();
                    swal.close();
                    window.swal({
                      icon: result.icon,
                      title: "Prediction",
                      text: "This is a " + result.prediction
                    }).then(function() {
                      stop_warning_audio();
                    });
                    x1 = 0;
                    y1 = 0;
                    x2 = 0;
                    y2 = 0;
                  }
                })
              }
            });

            $("#jaccard-operation").click(function() {
              var filename = $("#img").attr("src");

              if(x1 == 0 && x2 == 0 && y1 == 0 && y2 == 0) {
                window.swal({
                  title: "Error!",
                  text: "Select an area"
                });
              } else {
                window.swal({
                  title: "Computing jaccard index...",
                  text: "Please wait"
                });

                var height_ratio = height / 512;
                var width_ratio = width / 640;
                var scaled_x1 = x1 / height_ratio;
                var scaled_y1 = y1 / width_ratio;

                $.ajax({
                  url: "/jaccard",
                  type: "post",
                  dataType: "json",
                  data: {x1: scaled_x1, x2: x2, y1: scaled_y1, y2: y2, filename: filename},
                  success: function(result) {
                    $ias.cancelSelection();
                    swal.close();
                    window.swal({
                      icon: result.icon,
                      title: "Result",
                      text: result.status
                    });
                    x1 = 0;
                    y1 = 0;
                    x2 = 0;
                    y2 = 0;
                  }
                })
              }
            });

            $("#cosine-operation").click(function() {
              var filename = $("#img").attr("src");

              if(x1 == 0 && x2 == 0 && y1 == 0 && y2 == 0) {
                window.swal({
                  title: "Error!",
                  text: "Select an area"
                });
              } else {
                window.swal({
                  title: "Computing cosine similarity...",
                  text: "Please wait"
                });

                var height_ratio = height / 512;
                var width_ratio = width / 640;
                var scaled_x1 = x1 / height_ratio;
                var scaled_y1 = y1 / width_ratio;

                $.ajax({
                  url: "/cosine",
                  type: "post",
                  dataType: "json",
                  data: {x1: scaled_x1, x2: x2, y1: scaled_y1, y2: y2, filename: filename},
                  success: function(result) {
                    $ias.cancelSelection();
                    swal.close();
                    window.swal({
                      icon: result.icon,
                      title: "Result",
                      text: result.status
                    });
                    x1 = 0;
                    y1 = 0;
                    x2 = 0;
                    y2 = 0;
                  }
                })
              }
            });
        });
      </script>
    </body>
</html>
